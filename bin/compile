#!/bin/sh

ROOT_DIR=`pwd`
BUILD_DIR=$1
CACHE_DIR=$2

indent() {
    sed -u 's/^/       /'
}

arrow() {
    sed -u 's/^/-----> /'
}

echo "Fetching and installing skulltag binaries" | arrow
cd $CACHE_DIR

echo "Fetching base" | indent
if [ ! -f base.tar.bz2 ]; then
    curl -O http://www.skulltag.com/download/files/release/st-v098d_linux-base.tar.bz2 > /dev/null 2>&1
    mv st-v098d_linux-base.tar.bz2 base.tar.bz2
fi
echo "Fetching platform specific" | indent
if [ ! -f 64bit.tar.bz2 ]; then
    curl -O http://www.skulltag.com/download/files/release/st-v098d_linux-x86_64.tar.bz2 > /dev/null 2>&1
    mv st-v098d_linux-x86_64.tar.bz2 64bit.tar.bz2
fi

echo "Installing" | indent
tar xjf base.tar.bz2 -C $BUILD_DIR
tar xjf 64bit.tar.bz2 -C $BUILD_DIR

cd $ROOT_DIR
echo "Skulltag installed" | indent



echo "Installing dependencies" | arrow
# Can't apt-get on heroku obviously idiot, going to statically link
# apt-get -q install libjpeg62 2>&1| indent

echo "Preparing runtime configuration" | arrow
EXEC_CMD="/app/skulltag-server -host -private -port 10666"

if [ -f $BUILD_DIR/server.ini ]; then
    echo "Custom server.ini detected"
    EXEC_CMD="$EXEC_CMD +exec server.ini"
else
    echo "No server.ini found, using defaults"
fi | indent

if [ -f $BUILD_DIR/pwads.ini ]; then
    echo "Using pwads specified in pwads.ini"
else
    echo "No pwads specified, using all found in pwads/"
    od=`pwd`
    cd $BUILD_DIR
    for WAD in pwads/*.wad; do
        if [ "$WAD" != "pwads/*.wad" ]; then
            EXEC_CMD="$EXEC_CMD -file $WAD";
        fi
    done
    for WAD in pwads/*.WAD; do
        if [ "$WAD" != "pwads/*.WAD" ]; then
            EXEC_CMD="$EXEC_CMD -file $WAD";
        fi
    done
    cd $od
fi | indent



echo "Saving runtime configuration" | arrow
mkdir $BUILD_DIR/bin
echo $EXEC_CMD > $BUILD_DIR/bin/skulltag
chmod a+x $BUILD_DIR/bin/skulltag
